#!/bin/bash

function jolokia_opts {
  #!/bin/bash
  dir=${JOLOKIA_DIR:-/opt/jolokia}
  if [ -z ${JOLOKIA_OFF+x} ]; then
    opts="-javaagent:$dir/jolokia.jar"
    config=${JOLOKIA_CONFIG:-$dir/jolokia.properties}
    if [ -f "$JOLOKIA_CONFIG" ]; then
      # Configuration takes precedence
      opts="${opts}=config=${JOLOKIA_CONFIG}"
    else
      # Direct options only if no configuration is found
      opts="${opts}=host=${JOLOKIA_HOST:-*},agentId=${JOLOKIA_ID:-$HOSTNAME}"
      if [ -n "$JOLOKIA_PORT" ]; then
        opts="${opts},port=${JOLOKIA_PORT}"
      fi
      if [ -n "$JOLOKIA_AUTHMODE" ]; then
        opts="${opts},authMode=${JOLOKIA_AUTHMODE}"
      fi
      if [ -n "$JOLOKIA_AUTHURL" ]; then
        opts="${opts},authUrl=${JOLOKIA_AUTHURL}"
      fi
      if [ -n "$JOLOKIA_AUTHPRINCIPAL_SPEC" ]; then
        opts="${opts},authPrincipalSpec=${JOLOKIA_AUTHPRINCIPAL_SPEC}"
      fi
      if [ -n "$JOLOKIA_AUTHIGNORE_CERTS" ]; then
        opts="${opts},authIgnoreCerts=${JOLOKIA_AUTHIGNORE_CERTS}"
      fi
      if [ -n "$JOLOKIA_REALM" ]; then
        opts="${opts},realm=${JOLOKIA_REALM}"
      fi
      if [ -n "$JOLOKIA_USER" ]; then
        opts="${opts},user=${JOLOKIA_USER}"
      fi
      if [ -n "$JOLOKIA_PASSWORD" ]; then
        opts="${opts},password=${JOLOKIA_PASSWORD}"
      fi
    fi
    echo $opts
  fi
}

# Output from assemble script
DEPLOY_DIR=/opt/jboss

echo "Executing ${DEPLOY_DIR}/karaf/bin/karaf server ..."
if [ -z "${KARAF_OPTS}" ]; then
  KARAF_OPTS=$(jolokia_opts)
  export KARAF_OPTS
fi
${DEPLOY_DIR}/karaf/bin/karaf server
